name: Build and Push RuoQi Sys Admin

on:
  push:
    branches: [main]
    paths:
      - 'apps/ruoqi-sys-admin/**'
      - 'scripts/ruoqi-sys-admin-build/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.node-version'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version_tag:
        description: 'æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Node.js å’Œ pnpm
      - name: Setup Node and pnpm
        uses: ./.github/actions/setup-node

      # 3. å‡†å¤‡æ„å»ºè„šæœ¬
      - name: Prepare build scripts
        run: |
          echo "=== å‡†å¤‡æ„å»ºè„šæœ¬ ==="
          cd scripts/ruoqi-sys-admin-build
          chmod +x *.sh || true
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"

      # 4. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      - name: Generate version information
        id: version
        run: |
          echo "=== ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ ==="

          # æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬æ ‡ç­¾
          MANUAL_TAG="${{ github.event.inputs.version_tag }}"
          if [ -n "${MANUAL_TAG}" ]; then
            echo "tag=${MANUAL_TAG}" >> $GITHUB_OUTPUT
            echo "manual_tag=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ä» package.json è·å–ç‰ˆæœ¬
          VERSION="1.0.0"
          if [ -f "./apps/ruoqi-sys-admin/package.json" ]; then
            VERSION=$(node -p "require('./apps/ruoqi-sys-admin/package.json').version || '1.0.0'" 2>/dev/null || echo "1.0.0")
          fi

          SHORT_SHA=${GITHUB_SHA::8}
          DATE=$(date +'%Y%m%d')

          # æ ‡ç­¾åˆ—è¡¨
          TAG_LATEST="latest"
          TAG_VERSION="v${VERSION}"
          TAG_DATE_VERSION="v${VERSION}-${DATE}"
          TAG_FULL="v${VERSION}-${DATE}-${SHORT_SHA}"

          echo "tag_latest=${TAG_LATEST}" >> $GITHUB_OUTPUT
          echo "tag_version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_date_version=${TAG_DATE_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_full=${TAG_FULL}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "manual_tag=false" >> $GITHUB_OUTPUT

      # 5. æ„å»º Docker é•œåƒ
      - name: Build Docker image
        id: build
        run: |
          echo "=== æ„å»º Docker é•œåƒ ==="
          cd scripts/ruoqi-sys-admin-build

          # æ„å»ºé•œåƒ
          echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: ./build.sh --no-run"
          ./build.sh --no-run

          # éªŒè¯é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸ
          if docker images | grep -q "ruoqi-sys-admin"; then
            echo "âœ… Docker é•œåƒæ„å»ºæˆåŠŸ"
            echo "é•œåƒè¯¦æƒ…:"
            docker images | grep "ruoqi-sys-admin"
          else
            echo "âŒ Docker é•œåƒæ„å»ºå¤±è´¥"
            exit 1
          fi

      # 6. æ¨é€é•œåƒåˆ° Docker Hubï¼ˆå…³é”®æ­¥éª¤ï¼‰
      - name: Push to Docker Hub
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        env:
          # æ³¨æ„ï¼šè¿™é‡Œç›´æ¥ä½¿ç”¨ secretsï¼Œä¸ä½¿ç”¨ env å˜é‡ä¸­è½¬
          DOCKER_HUB_USER: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        run: |
          echo "=== æ¨é€é•œåƒåˆ° Docker Hub ==="
          echo "å½“å‰ç›®å½•: $(pwd)"

          # è¿›å…¥è„šæœ¬ç›®å½•
          cd scripts/ruoqi-sys-admin-build

          # è°ƒè¯•ï¼šæ˜¾ç¤ºç¯å¢ƒå˜é‡ï¼ˆæ³¨æ„åç§°å˜åŒ–ï¼‰
          echo "ğŸ” ç¯å¢ƒå˜é‡è°ƒè¯•ä¿¡æ¯ï¼š"
          echo "DOCKER_HUB_USER: ${DOCKER_HUB_USER}"
          echo "DOCKER_HUB_TOKEN é•¿åº¦: ${#DOCKER_HUB_TOKEN}"

          # ç¡®å®šè¦æ¨é€çš„æ ‡ç­¾
          if [[ "${{ steps.version.outputs.manual_tag }}" == "true" ]]; then
            TAGS=("${{ steps.version.outputs.tag }}")
            echo "ä½¿ç”¨æ‰‹åŠ¨æ ‡ç­¾: ${TAGS[0]}"
          else
            TAGS=(
              "${{ steps.version.outputs.tag_latest }}"
              "${{ steps.version.outputs.tag_version }}"
              "${{ steps.version.outputs.tag_date_version }}"
              "${{ steps.version.outputs.tag_full }}"
            )
            echo "ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æ ‡ç­¾:"
            printf '  - %s\n' "${TAGS[@]}"
          fi

          # æ¨é€æ‰€æœ‰æ ‡ç­¾
          for TAG in "${TAGS[@]}"; do
            echo ""
            echo "ğŸš€ æ¨é€æ ‡ç­¾: ${TAG}"
            echo "----------------------------------------"

            # ä½¿ç”¨æ–°çš„ç¯å¢ƒå˜é‡å
            DOCKER_HUB_USERNAME="${DOCKER_HUB_USER}" \
            DOCKER_HUB_ACCESS_TOKEN="${DOCKER_HUB_TOKEN}" \
            ./push.sh "${TAG}"

            # æ·»åŠ å»¶æ—¶
            if [ "$TAG" != "${TAGS[-1]}" ]; then
              echo "ç­‰å¾… 2 ç§’åæ¨é€ä¸‹ä¸€ä¸ªæ ‡ç­¾..."
              sleep 2
            fi
          done

          echo "ğŸ‰ æ‰€æœ‰é•œåƒæ¨é€å®Œæˆï¼"

      # 7. åˆ›å»ºæ„å»ºæ‘˜è¦
      - name: Create build summary
        if: always()
        run: |
          echo "## ğŸ—ï¸ RuoQi Sys Admin æ„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æ„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤:** ${{ steps.version.outputs.sha_short }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¥æœŸ:** ${{ steps.version.outputs.date }}" >> $GITHUB_STEP_SUMMARY

      # 8. ä¸Šä¼ æ„å»ºæ—¥å¿—
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            scripts/ruoqi-sys-admin-build/build.log
            scripts/ruoqi-sys-admin-build/*.log
          retention-days: 30

      # 9. æ¸…ç† Docker èµ„æº
      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "=== æ¸…ç† Docker èµ„æº ==="

          # åˆ é™¤æ„å»ºçš„é•œåƒ
          docker rmi ruoqi-sys-admin:latest 2>/dev/null || true

          # æ¸…ç†æ— ç”¨çš„ Docker èµ„æº
          docker system prune -f 2>/dev/null || true

          echo "âœ… èµ„æºæ¸…ç†å®Œæˆ"

  # 10. é€šçŸ¥ä»»åŠ¡
  notification:
    name: ğŸ“¢ Build Notification
    runs-on: ubuntu-latest
    needs: [build_and_push]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "=== RuoQi Sys Admin æ„å»ºé€šçŸ¥ ==="
          echo ""

          # åŸºæœ¬æ„å»ºä¿¡æ¯
          echo "**é¡¹ç›®:** RuoQi Sys Admin"
          echo "**ä»“åº“:** ${{ github.repository }}"
          echo "**åˆ†æ”¯:** ${{ github.ref_name }}"
          echo "**è§¦å‘è€…:** ${{ github.actor }}"
          echo "**å·¥ä½œæµ:** ${{ github.workflow }} #${{ github.run_number }}"
          echo "**çŠ¶æ€:** ${{ needs.build_and_push.result }}"
          echo ""

          # æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
          if [ "${{ needs.build_and_push.result }}" = "success" ]; then
            echo "ğŸ‰ **æ„å»ºæˆåŠŸï¼**"
            echo ""

            # é•œåƒä¿¡æ¯
            if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "ğŸ“¦ **Docker é•œåƒå·²å‘å¸ƒ:**"
              echo ""

              if [[ "${{ needs.build_and_push.outputs.manual_tag }}" == "true" ]]; then
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag }}\`"
              else
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:latest\`"
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag_version }}\`"
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag_date_version }}\`"
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag_full }}\`"
              fi

              echo ""
              echo "ğŸ”— **ç›¸å…³é“¾æ¥:**"
              echo "  - [Docker Hub ä»“åº“](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin)"
              echo "  - [æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin/tags)"
              echo "  - [æ„å»ºè¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            else
              echo "ğŸ§ª **æµ‹è¯•æ„å»ºå®Œæˆ**"
              echo "é•œåƒä»…åœ¨æœ¬åœ°æ„å»ºï¼Œæœªæ¨é€åˆ° Docker Hub"
            fi
          else
            echo "âŒ **æ„å»ºå¤±è´¥ï¼**"
            echo ""
            echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› :"
            echo "  1. æ„å»ºè„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo "  2. Docker é•œåƒæ„å»ºé”™è¯¯"
            echo "  3. ç½‘ç»œè¿æ¥é—®é¢˜"
            echo "  4. æƒé™é…ç½®é”™è¯¯"
            echo ""
            echo "ğŸ“‹ **æ’æŸ¥æ­¥éª¤:**"
            echo "  1. æŸ¥çœ‹ GitHub Actions æ—¥å¿—"
            echo "  2. æ£€æŸ¥ Secrets é…ç½®"
            echo "  3. éªŒè¯æœ¬åœ°æ„å»ºæ˜¯å¦æ­£å¸¸"
            echo ""
            echo "ğŸ”— **æ„å»ºæ—¥å¿—:**"
            echo "  https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo ""
          echo "---"
          echo "ğŸ“Š **æ„å»ºä¿¡æ¯æ±‡æ€»:**"
          echo "- ç‰ˆæœ¬: ${{ needs.build_and_push.outputs.version }}"
          echo "- æäº¤: ${{ needs.build_and_push.outputs.sha_short }}"
          echo "- æ—¥æœŸ: ${{ needs.build_and_push.outputs.date }}"
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
