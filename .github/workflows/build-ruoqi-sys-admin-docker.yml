name: Build and Push RuoQi Sys Admin

on:
  push:
    branches: [main]
    paths:
      - 'apps/ruoqi-sys-admin/**'
      - 'scripts/ruoqi-sys-admin-build/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js with pnpm
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Install pnpm via corepack
        run: |
          echo "=== å®‰è£… pnpm ==="
          # å¯ç”¨ corepackï¼ˆNode.js 16+ å†…ç½®çš„åŒ…ç®¡ç†å™¨ç®¡ç†å™¨ï¼‰
          corepack enable

          # å®‰è£… pnpm
          corepack prepare pnpm@latest --activate

          echo "pnpm ç‰ˆæœ¬:"
          pnpm --version
          echo "Node ç‰ˆæœ¬:"
          node --version

      - name: Run build script
        run: |
          echo "=== è¿è¡Œæ„å»ºè„šæœ¬ ==="
          cd scripts/ruoqi-sys-admin-build

          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x build.sh || true

          # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "build.sh" ]; then
            echo "é”™è¯¯: build.sh è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi

          # è¿è¡Œæ„å»ºè„šæœ¬ï¼ˆåªæ„å»ºä¸è¿è¡Œå®¹å™¨ï¼‰
          ./build.sh --no-run  # åªæ„å»ºï¼Œä¸è¿è¡Œå®¹å™¨

      - name: Generate version tag
        id: version
        run: |
          echo "=== ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾ ==="

          # è·å–ç‰ˆæœ¬å·
          VERSION="1.0.0"
          if [ -f "./apps/ruoqi-sys-admin/package.json" ]; then
            VERSION=$(node -p "require('./apps/ruoqi-sys-admin/package.json').version || '1.0.0'" 2>/dev/null || echo "1.0.0")
          fi

          SHORT_SHA=${GITHUB_SHA::8}
          DATE=$(date +'%Y%m%d')
          TAG="v${VERSION}-${DATE}-${SHORT_SHA}"

          echo "Version: ${VERSION}"
          echo "Commit SHA: ${SHORT_SHA}"
          echo "Date: ${DATE}"
          echo "Full tag: ${TAG}"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Push to Docker Hub
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        run: |
          echo "=== æ¨é€é•œåƒåˆ° Docker Hub ==="
          cd scripts/ruoqi-sys-admin-build

          # æ£€æŸ¥æ¨é€è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "push-multi.sh" ]; then
            echo "é”™è¯¯: push-multi.sh è„šæœ¬ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨ push.sh"
            if [ ! -f "push.sh" ]; then
              echo "é”™è¯¯: push.sh è„šæœ¬ä¹Ÿä¸å­˜åœ¨"
              exit 1
            fi
            PUSH_SCRIPT="push.sh"
          else
            PUSH_SCRIPT="push-multi.sh"
          fi

          chmod +x "$PUSH_SCRIPT"

          # è®¾ç½®ç¯å¢ƒå˜é‡
          export DOCKER_HUB_USERNAME="${{ env.DOCKER_HUB_USERNAME }}"
          export DOCKER_HUB_ACCESS_TOKEN="${{ env.DOCKER_HUB_ACCESS_TOKEN }}"

          echo "ä½¿ç”¨æ¨é€è„šæœ¬: $PUSH_SCRIPT"

          # è¿è¡Œæ¨é€è„šæœ¬
          if [ "$PUSH_SCRIPT" = "push-multi.sh" ]; then
            # ä½¿ç”¨ push-multi.sh æ¨é€å¤šä¸ªæ ‡ç­¾
            ./push-multi.sh
          else
            # ä½¿ç”¨ push.sh æ¨é€å¤šä¸ªæ ‡ç­¾
            # æ¨é€ä¸‰ä¸ªæ ‡ç­¾ï¼šlatestã€ç‰ˆæœ¬æ ‡ç­¾ã€æ—¥æœŸæäº¤æ ‡ç­¾
            echo "æ¨é€æ ‡ç­¾: latest"
            ./push.sh latest

            echo "æ¨é€æ ‡ç­¾: ${{ steps.version.outputs.tag }}"
            ./push.sh "${{ steps.version.outputs.tag }}"

            echo "æ¨é€æ ‡ç­¾: v${{ steps.version.outputs.version }}"
            ./push.sh "v${{ steps.version.outputs.version }}"
          fi

      - name: Create build summary
        if: success()
        run: |
          echo "## ğŸ‰ RuoQi Sys Admin æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "### ğŸ“¦ Docker é•œåƒ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:v${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”— ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [Docker Hub ä»“åº“](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin)" >> $GITHUB_STEP_SUMMARY
            echo "- [æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin/tags)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ§ª æµ‹è¯•æ„å»º" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "æœ¬æ¬¡ä¸º PR æˆ–æµ‹è¯•æ„å»ºï¼Œé•œåƒæœªæ¨é€åˆ° Docker Hub" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµ:** [${{ github.workflow }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´:** ${{ steps.version.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            scripts/ruoqi-sys-admin-build/build.log
          retention-days: 7

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [build]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "=== æ„å»ºé€šçŸ¥ ==="
          echo ""

          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "âœ… RuoQi Sys Admin æ„å»ºæˆåŠŸï¼"
            echo ""

            if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "ğŸ“¦ é•œåƒå·²æ¨é€åˆ° Docker Hub:"
              echo "  - ${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:latest"
              echo "  - ${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build.outputs.tag }}"
              echo "  - ${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:v${{ needs.build.outputs.version }}"
              echo ""
              echo "ğŸ”— æŸ¥çœ‹é•œåƒ:"
              echo "  https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin/tags"
            else
              echo "ğŸ§ª æµ‹è¯•æ„å»ºå®Œæˆ"
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼"
            echo ""
            echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—æˆ–ä¸‹è½½æ—¥å¿—æ–‡ä»¶æŸ¥çœ‹è¯¦æƒ…ã€‚"
          fi
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
