name: Build and Push RuoQi Sys Admin

on:
  push:
    branches: [main]
    paths:
      - 'apps/ruoqi-sys-admin/**'
      - 'scripts/ruoqi-sys-admin-build/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.node-version'

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Node.js å’Œ pnpm
      - name: Setup Node and pnpm
        uses: ./.github/actions/setup-node

      # 3. å‡†å¤‡æ„å»ºè„šæœ¬
      - name: Prepare build scripts
        run: |
          echo "=== å‡†å¤‡æ„å»ºè„šæœ¬ ==="
          cd scripts/ruoqi-sys-admin-build
          chmod +x *.sh || true
          echo "âœ… è„šæœ¬æƒé™è®¾ç½®å®Œæˆ"

      # 4. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      - name: Generate version information
        id: version
        run: |
          echo "=== ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ ==="

          # æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬æ ‡ç­¾
          MANUAL_TAG="${{ github.event.inputs.version_tag }}"
          if [ -n "${MANUAL_TAG}" ]; then
            echo "tag=${MANUAL_TAG}" >> $GITHUB_OUTPUT
            echo "manual_tag=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ä» package.json è·å–ç‰ˆæœ¬
          VERSION="1.0.0"
          if [ -f "./apps/ruoqi-sys-admin/package.json" ]; then
            VERSION=$(node -p "require('./apps/ruoqi-sys-admin/package.json').version || '1.0.0'" 2>/dev/null || echo "1.0.0")
          fi

          SHORT_SHA=${GITHUB_SHA::8}
          DATE=$(date +'%Y%m%d')

          # æ ‡ç­¾åˆ—è¡¨
          TAG_LATEST="latest"
          TAG_VERSION="v${VERSION}"
          TAG_DATE_VERSION="v${VERSION}-${DATE}"
          TAG_FULL="v${VERSION}-${DATE}-${SHORT_SHA}"

          echo "tag_latest=${TAG_LATEST}" >> $GITHUB_OUTPUT
          echo "tag_version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_date_version=${TAG_DATE_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_full=${TAG_FULL}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "manual_tag=false" >> $GITHUB_OUTPUT

      # 5. æ„å»º Docker é•œåƒ
      - name: Build Docker image
        id: build
        run: |
          echo "=== æ„å»º Docker é•œåƒ ==="
          cd scripts/ruoqi-sys-admin-build

          # æ„å»ºé•œåƒ
          echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: ./build.sh --no-run"
          ./build.sh --no-run

          # éªŒè¯é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸ
          if docker images | grep -q "ruoqi-sys-admin"; then
            echo "âœ… Docker é•œåƒæ„å»ºæˆåŠŸ"
            echo "é•œåƒè¯¦æƒ…:"
            docker images | grep "ruoqi-sys-admin"
          else
            echo "âŒ Docker é•œåƒæ„å»ºå¤±è´¥"
            exit 1
          fi

      # 6. æ¨é€é•œåƒåˆ° Docker Hubï¼ˆå…³é”®æ­¥éª¤ï¼‰
      - name: Push to Docker Hub
        run: |
          echo "=== æ„å»º Docker é•œåƒ ==="
          cd scripts/ruoqi-sys-admin-build

          # æ„å»ºé•œåƒ
          echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: ./push.sh"
          ./push.sh

      # 9. æ¸…ç† Docker èµ„æº
      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "=== æ¸…ç† Docker èµ„æº ==="

          # åˆ é™¤æ„å»ºçš„é•œåƒ
          docker rmi ruoqi-sys-admin:latest 2>/dev/null || true

          # æ¸…ç†æ— ç”¨çš„ Docker èµ„æº
          docker system prune -f 2>/dev/null || true

          echo "âœ… èµ„æºæ¸…ç†å®Œæˆ"

  # 10. é€šçŸ¥ä»»åŠ¡
  notification:
    name: ğŸ“¢ Build Notification
    runs-on: ubuntu-latest
    needs: [build_and_push]
    if: always()
