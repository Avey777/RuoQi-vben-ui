name: Build and Push RuoQi Sys Admin

on:
  push:
    branches:
      - 'main'
      - 'sys'

jobs:
  docker_push:
    if: startsWith(github.server_url, 'https://github.com')
    name: Build and Push Application with Docker
    runs-on: ubuntu-latest
    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v5

      ### æ­¥éª¤1: è®¾ç½® Node.js ###
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      ### æ­¥éª¤2: å®‰è£…æ­£ç¡®ç‰ˆæœ¬çš„ pnpm ###
      - name: Install and setup pnpm
        run: |
          # å¸è½½å¯èƒ½å­˜åœ¨çš„æ—§ç‰ˆæœ¬ï¼Œå®‰è£…é¡¹ç›®è¦æ±‚çš„ pnpm 9.12.0 æˆ–æ›´é«˜ç‰ˆæœ¬
          npm uninstall -g pnpm 2>/dev/null || true
          npm install -g pnpm@9
          # éªŒè¯ç‰ˆæœ¬
          pnpm --version

      ### æ­¥éª¤3: ï¼ˆå¯é€‰ï¼‰æ£€æŸ¥é¡¹ç›®æ ¹ç›®å½•çš„ package.json ###
      - name: Check project configuration
        run: |
          echo "æ£€æŸ¥é¡¹ç›® pnpm å¼•æ“è¦æ±‚..."
          if [ -f "./apps/ruoqi-sys-admin/package.json" ]; then
            cd ./apps/ruoqi-sys-admin
            node -p "JSON.parse(require('fs').readFileSync('package.json')).engines?.pnpm || 'æœªæŒ‡å®š pnpm ç‰ˆæœ¬è¦æ±‚'"
          else
            echo "æœªåœ¨ apps/ruoqi-sys-admin ä¸‹æ‰¾åˆ° package.json"
          fi

      ### æ­¥éª¤3: è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™ï¼ˆæ–°å¢ï¼‰###
      - name: Make scripts executable
        run: |
          chmod +x ./scripts/ruoqi-sys-admin/docker_build.sh
          chmod +x ./scripts/ruoqi-sys-admin/docker_push.sh

      ### åŸæœ‰æ„å»ºæ­¥éª¤ ###
      - name: Build Docker image
        run: |
          ./scripts/ruoqi-sys-admin/docker_build.sh

      - name: docker images
        run: docker images

      - name: Push Docker image
        run: |
          echo "DEBUG: æ£€æŸ¥ç¯å¢ƒå˜é‡"
          echo "DOCKER_HUB_USERNAME: $DOCKER_HUB_USERNAME"
          echo "DOCKER_HUB_ACCESS_TOKEN: ${DOCKER_HUB_ACCESS_TOKEN:0:4}..."  # åªæ˜¾ç¤ºå‰4ä½
          ./scripts/ruoqi-sys-admin/docker_push.sh

  notification:
    if: startsWith(github.server_url, 'https://github.com')
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline status
        run: echo "ğŸ This job's status is ${{ job.status }}."
