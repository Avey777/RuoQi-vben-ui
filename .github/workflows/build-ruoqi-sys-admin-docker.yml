name: Build and Push RuoQi Sys Admin

on:
  push:
    branches: [main]
    paths:
      - 'apps/ruoqi-sys-admin/**'
      - 'scripts/ruoqi-sys-admin-build/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.node-version'

  # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œå¦‚ï¼šv1.2.3ï¼‰'
        required: false
        type: string

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      IMAGE_NAME: ruoqi-sys-admin
      REGISTRY: docker.io
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Node.js å’Œ pnpm
      - name: Setup Node and pnpm
        uses: ./.github/actions/setup-node

      # 3. å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: Prepare build environment
        run: |
          echo "=== å‡†å¤‡æ„å»ºç¯å¢ƒ ==="

          # æ£€æŸ¥å¿…è¦çš„è„šæœ¬æ–‡ä»¶
          if [ ! -f "scripts/ruoqi-sys-admin-build/build.sh" ]; then
            echo "âŒ æœªæ‰¾åˆ° build.sh è„šæœ¬"
            exit 1
          fi

          if [ ! -f "scripts/ruoqi-sys-admin-build/push.sh" ]; then
            echo "âŒ æœªæ‰¾åˆ° push.sh è„šæœ¬"
            exit 1
          fi

          # è®¾ç½®è„šæœ¬æƒé™
          cd scripts/ruoqi-sys-admin-build
          chmod +x build.sh push.sh

          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p logs

          echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"

      # 4. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      - name: Generate version information
        id: version
        run: |
          echo "=== ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ ==="
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "æäº¤SHA: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"

          # æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬æ ‡ç­¾
          MANUAL_TAG="${{ github.event.inputs.version_tag }}"
          if [ -n "${MANUAL_TAG}" ]; then
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬æ ‡ç­¾: ${MANUAL_TAG}"
            echo "tag=${MANUAL_TAG}" >> $GITHUB_OUTPUT
            echo "version=${MANUAL_TAG#v}" >> $GITHUB_OUTPUT  # å»æ‰ v å‰ç¼€
            echo "manual_tag=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ä» package.json è·å–ç‰ˆæœ¬
          VERSION="1.0.0"
          if [ -f "./apps/ruoqi-sys-admin/package.json" ]; then
            VERSION=$(node -p "require('./apps/ruoqi-sys-admin/package.json').version || '1.0.0'" 2>/dev/null || echo "1.0.0")
          fi

          SHORT_SHA=${GITHUB_SHA::8}
          DATE=$(date +'%Y%m%d')
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')

          # æ ‡ç­¾åˆ—è¡¨
          TAG_LATEST="latest"
          TAG_VERSION="v${VERSION}"
          TAG_DATE_VERSION="v${VERSION}-${DATE}"
          TAG_FULL="v${VERSION}-${DATE}-${SHORT_SHA}"
          TAG_TIMESTAMP="v${VERSION}-${TIMESTAMP}-${SHORT_SHA}"

          echo "ğŸ”– ç”Ÿæˆçš„æ ‡ç­¾:"
          echo "  - latest: ${TAG_LATEST}"
          echo "  - ç‰ˆæœ¬: ${TAG_VERSION}"
          echo "  - æ—¥æœŸç‰ˆæœ¬: ${TAG_DATE_VERSION}"
          echo "  - å®Œæ•´ç‰ˆæœ¬: ${TAG_FULL}"
          echo "  - æ—¶é—´æˆ³ç‰ˆæœ¬: ${TAG_TIMESTAMP}"

          echo "tag_latest=${TAG_LATEST}" >> $GITHUB_OUTPUT
          echo "tag_version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_date_version=${TAG_DATE_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_full=${TAG_FULL}" >> $GITHUB_OUTPUT
          echo "tag_timestamp=${TAG_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "manual_tag=false" >> $GITHUB_OUTPUT

      # 5. è®¾ç½®ç¯å¢ƒå˜é‡ä¾›è„šæœ¬ä½¿ç”¨
      - name: Set environment variables for scripts
        run: |
          echo "=== è®¾ç½®ç¯å¢ƒå˜é‡ ==="

          # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾› build.sh å’Œ push.sh ä½¿ç”¨
          echo "DOCKER_HUB_USERNAME=${{ secrets.DOCKER_HUB_USERNAME }}" >> $GITHUB_ENV
          echo "IMAGE_VERSION=${{ steps.version.outputs.version }}" >> $GITHUB_ENV
          echo "GIT_SHA_SHORT=${{ steps.version.outputs.sha_short }}" >> $GITHUB_ENV
          echo "BUILD_DATE=${{ steps.version.outputs.date }}" >> $GITHUB_ENV

          # æ„å»ºå®Œæ•´çš„é•œåƒæ ‡ç­¾
          FULL_IMAGE_TAG="${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_full }}"
          echo "FULL_IMAGE_TAG=${FULL_IMAGE_TAG}" >> $GITHUB_ENV

          echo "âœ… ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ"
          echo "é•œåƒæ ‡ç­¾: ${FULL_IMAGE_TAG}"

      # 6. ç™»å½•åˆ° Docker Registry
      - name: Login to Docker Registry
        if: env.DOCKER_HUB_USERNAME != '' && env.DOCKER_HUB_ACCESS_TOKEN != ''
        run: |
          echo "=== ç™»å½•åˆ° Docker Hub ==="
          echo ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }} | docker login \
            -u ${{ secrets.DOCKER_HUB_USERNAME }} \
            --password-stdin
          echo "âœ… ç™»å½•æˆåŠŸ"

      # 7. æ‰§è¡Œæ„å»ºè„šæœ¬
      - name: Execute build script
        id: build
        run: |
          echo "=== æ‰§è¡Œæ„å»ºè„šæœ¬ ==="
          cd scripts/ruoqi-sys-admin-build

          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)

          # æ‰§è¡Œæ„å»ºè„šæœ¬
          echo "æ‰§è¡Œå‘½ä»¤: ./build.sh --no-run"
          if ./build.sh --no-run; then
            BUILD_STATUS="success"
            echo "âœ… æ„å»ºè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            BUILD_STATUS="failed"
            echo "âŒ æ„å»ºè„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi

          # è®°å½•ç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "æ„å»ºè€—æ—¶: ${DURATION}ç§’"
          echo "build_status=${BUILD_STATUS}" >> $GITHUB_OUTPUT
          echo "build_duration=${DURATION}" >> $GITHUB_OUTPUT

      # 8. éªŒè¯ Docker é•œåƒ
      - name: Verify Docker image
        run: |
          echo "=== éªŒè¯ Docker é•œåƒ ==="

          # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          if docker images | grep -q "ruoqi-sys-admin"; then
            echo "âœ… æ‰¾åˆ° ruoqi-sys-admin é•œåƒ"
            echo "é•œåƒåˆ—è¡¨:"
            docker images | head -20
          else
            echo "âŒ æœªæ‰¾åˆ° ruoqi-sys-admin é•œåƒ"
            exit 1
          fi

          # æ˜¾ç¤ºé•œåƒè¯¦ç»†ä¿¡æ¯
          echo "é•œåƒè¯¦ç»†ä¿¡æ¯:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" | grep ruoqi-sys-admin

      # 9. æ ‡è®° Docker é•œåƒï¼ˆå¤šä¸ªæ ‡ç­¾ï¼‰
      - name: Tag Docker images
        run: |
          echo "=== æ ‡è®° Docker é•œåƒ ==="

          # è·å–é•œåƒID
          IMAGE_ID=$(docker images -q ruoqi-sys-admin:latest)

          if [ -z "$IMAGE_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ° ruoqi-sys-admin:latest é•œåƒ"
            exit 1
          fi

          echo "æºé•œåƒID: ${IMAGE_ID}"

          # æ ‡è®°å¤šä¸ªç‰ˆæœ¬æ ‡ç­¾
          TAGS=(
            "${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_latest }}"
            "${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_version }}"
            "${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_date_version }}"
            "${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_full }}"
            "${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_timestamp }}"
          )

          for TAG in "${TAGS[@]}"; do
            echo "æ ‡è®°ä¸º: ${TAG}"
            docker tag ${IMAGE_ID} ${TAG}
          done

          echo "âœ… é•œåƒæ ‡è®°å®Œæˆ"
          echo "å½“å‰æ‰€æœ‰ ruoqi-sys-admin é•œåƒ:"
          docker images | grep ruoqi-sys-admin

      # 10. æ‰§è¡Œæ¨é€è„šæœ¬
      - name: Execute push script
        id: push
        run: |
          echo "=== æ‰§è¡Œæ¨é€è„šæœ¬ ==="
          cd scripts/ruoqi-sys-admin-build

          # è®°å½•å¼€å§‹æ—¶é—´
          START_TIME=$(date +%s)

          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾› push.sh ä½¿ç”¨
          export DOCKER_USERNAME="${{ secrets.DOCKER_HUB_USERNAME }}"
          export IMAGE_NAME="ruoqi-sys-admin"
          export VERSION="${{ steps.version.outputs.tag_full }}"

          echo "æ‰§è¡Œå‘½ä»¤: ./push.sh"
          if ./push.sh; then
            PUSH_STATUS="success"
            echo "âœ… æ¨é€è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            PUSH_STATUS="failed"
            echo "âŒ æ¨é€è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi

          # è®°å½•ç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "æ¨é€è€—æ—¶: ${DURATION}ç§’"
          echo "push_status=${PUSH_STATUS}" >> $GITHUB_OUTPUT
          echo "push_duration=${DURATION}" >> $GITHUB_OUTPUT

      # 11. è¾“å‡ºé•œåƒä¿¡æ¯
      - name: Output image information
        run: |
          echo "=== é•œåƒä¿¡æ¯æ±‡æ€» ==="
          echo "ğŸ‰ Docker é•œåƒæ„å»ºå’Œæ¨é€å®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ é•œåƒä¿¡æ¯:"
          echo "  - é•œåƒåç§°: ${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin"
          echo "  - åº”ç”¨ç‰ˆæœ¬: v${{ steps.version.outputs.version }}"
          echo "  - Git SHA: ${{ steps.version.outputs.sha_short }}"
          echo "  - æ„å»ºæ—¥æœŸ: ${{ steps.version.outputs.date }}"
          echo ""
          echo "ğŸ·ï¸ å¯ç”¨æ ‡ç­¾:"
          echo "  - ${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:latest"
          echo "  - ${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_version }}"
          echo "  - ${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_date_version }}"
          echo "  - ${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_full }}"
          echo ""
          echo "â±ï¸ æ„å»ºç»Ÿè®¡:"
          echo "  - æ„å»ºè€—æ—¶: ${{ steps.build.outputs.build_duration }}ç§’"
          echo "  - æ¨é€è€—æ—¶: ${{ steps.push.outputs.push_duration }}ç§’"

      # 12. ä¸Šä¼ æ„å»ºæ—¥å¿—
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-build-logs
          path: |
            scripts/ruoqi-sys-admin-build/logs/
            scripts/ruoqi-sys-admin-build/*.log
          retention-days: 30

      # 13. æ¸…ç† Docker èµ„æº
      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "=== æ¸…ç† Docker èµ„æº ==="

          # åˆ é™¤æ‰€æœ‰ ruoqi-sys-admin ç›¸å…³çš„é•œåƒ
          echo "åˆ é™¤æœ¬åœ°é•œåƒ..."
          docker images --format "{{.Repository}}:{{.Tag}}" | grep ruoqi-sys-admin | xargs -r docker rmi || true

          # æ¸…ç†æ„å»ºç¼“å­˜
          echo "æ¸…ç†æ„å»ºç¼“å­˜..."
          docker builder prune -f || true

          # æ¸…ç†æ— ç”¨çš„å®¹å™¨å’Œç½‘ç»œ
          echo "æ¸…ç†æ— ç”¨èµ„æº..."
          docker system prune -f --volumes || true

          echo "âœ… èµ„æºæ¸…ç†å®Œæˆ"

  # 14. é€šçŸ¥ä»»åŠ¡
  notification:
    name: ğŸ“¢ æ„å»ºé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build_and_push]
    if: always()
    steps:
      - name: Determine notification status
        id: status
        run: |
          if [ "${{ needs.build_and_push.result }}" = "success" ]; then
            echo "status=âœ… æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          elif [ "${{ needs.build_and_push.result }}" = "failure" ]; then
            echo "status=âŒ å¤±è´¥" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          else
            echo "status=âš ï¸  å–æ¶ˆ" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi

      - name: Send summary notification
        run: |
          echo "=== æ„å»ºç»“æœæ±‡æ€» ==="
          echo ""
          echo "ğŸ“‹ é¡¹ç›®: RuoQi ç³»ç»Ÿç®¡ç†åå°"
          echo "ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“Š çŠ¶æ€: ${{ steps.status.outputs.status }}"
          echo ""
          echo "ğŸ”— ç›¸å…³ä¿¡æ¯:"
          echo "  - ä»“åº“: ${{ github.repository }}"
          echo "  - åˆ†æ”¯: ${{ github.ref_name }}"
          echo "  - æäº¤: ${{ github.sha }}"
          echo "  - è§¦å‘è€…: ${{ github.actor }}"
          echo ""

          if [ "${{ needs.build_and_push.result }}" = "success" ]; then
            echo "ğŸš€ æ„å»ºæˆåŠŸï¼é•œåƒå·²æ¨é€åˆ° Docker Hub"
            echo ""
            echo "ğŸ“¦ é•œåƒåœ°å€:"
            echo "  docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag_full }}"
            echo ""
            echo "ğŸ·ï¸ å¯ç”¨æ ‡ç­¾:"
            echo "  - latest"
            echo "  - ${{ needs.build_and_push.outputs.tag_version }}"
            echo "  - ${{ needs.build_and_push.outputs.tag_full }}"
          fi

          echo ""
          echo "ğŸ“ è¯¦ç»†æ—¥å¿—:"
          echo "  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
