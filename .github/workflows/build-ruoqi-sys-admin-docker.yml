name: Build and Push RuoQi Sys Admin

on:
  push:
    branches: [main]
    paths:
      - 'apps/ruoqi-sys-admin/**'
      - 'scripts/ruoqi-sys-admin-build/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.node-version'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version_tag:
        description: 'æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''

jobs:
  build_and_push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Node.js å’Œ pnpm
      - name: Setup Node and pnpm
        uses: ./.github/actions/setup-node

      # 3. å‡†å¤‡æ„å»ºè„šæœ¬
      - name: Prepare build scripts
        run: |
          echo "=== å‡†å¤‡æ„å»ºè„šæœ¬ ==="
          cd scripts/ruoqi-sys-admin-build

          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x *.sh || true

          # æ˜¾ç¤ºè„šæœ¬ä¿¡æ¯
          echo "è„šæœ¬åˆ—è¡¨:"
          ls -la *.sh

          # éªŒè¯å¿…è¦è„šæœ¬
          if [ ! -f "build.sh" ]; then
            echo "âŒ é”™è¯¯: build.sh è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi

          if [ ! -f "push.sh" ]; then
            echo "âŒ é”™è¯¯: push.sh è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi

      # 4. ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      - name: Generate version information
        id: version
        run: |
          echo "=== ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯ ==="

          # æ£€æŸ¥æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬æ ‡ç­¾
          MANUAL_TAG="${{ github.event.inputs.version_tag }}"
          if [ -n "${MANUAL_TAG}" ]; then
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„æ ‡ç­¾: ${MANUAL_TAG}"
            echo "tag=${MANUAL_TAG}" >> $GITHUB_OUTPUT
            echo "manual_tag=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ä» package.json è·å–ç‰ˆæœ¬
          VERSION="1.0.0"
          if [ -f "./apps/ruoqi-sys-admin/package.json" ]; then
            VERSION=$(node -p "require('./apps/ruoqi-sys-admin/package.json').version || '1.0.0'" 2>/dev/null || echo "1.0.0")
          fi

          # ç”Ÿæˆå„ç§æ ‡ç­¾
          SHORT_SHA=${GITHUB_SHA::8}
          DATE=$(date +'%Y%m%d')

          # æ ‡ç­¾åˆ—è¡¨
          TAG_LATEST="latest"
          TAG_VERSION="v${VERSION}"
          TAG_DATE_VERSION="v${VERSION}-${DATE}"
          TAG_FULL="v${VERSION}-${DATE}-${SHORT_SHA}"

          echo "åŸºç¡€ç‰ˆæœ¬: ${VERSION}"
          echo "æäº¤å“ˆå¸Œ: ${SHORT_SHA}"
          echo "æ„å»ºæ—¥æœŸ: ${DATE}"
          echo ""
          echo "ç”Ÿæˆçš„æ ‡ç­¾:"
          echo "  1. ${TAG_LATEST} (latest)"
          echo "  2. ${TAG_VERSION} (è¯­ä¹‰åŒ–ç‰ˆæœ¬)"
          echo "  3. ${TAG_DATE_VERSION} (å¸¦æ—¥æœŸç‰ˆæœ¬)"
          echo "  4. ${TAG_FULL} (å®Œæ•´ç‰ˆæœ¬)"

          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
          echo "tag_latest=${TAG_LATEST}" >> $GITHUB_OUTPUT
          echo "tag_version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_date_version=${TAG_DATE_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_full=${TAG_FULL}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          echo "manual_tag=false" >> $GITHUB_OUTPUT

      # 5. æ„å»º Docker é•œåƒ
      - name: Build Docker image
        id: build
        run: |
          echo "=== æ„å»º Docker é•œåƒ ==="
          cd scripts/ruoqi-sys-admin-build

          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ‰‹åŠ¨æ ‡ç­¾
          if [[ "${{ steps.version.outputs.manual_tag }}" == "true" ]]; then
            echo "ä½¿ç”¨æ‰‹åŠ¨æ ‡ç­¾æ¨¡å¼"
          fi

          # æ„å»ºé•œåƒï¼ˆä½¿ç”¨ --no-run å‚æ•°åªæ„å»ºä¸è¿è¡Œï¼‰
          echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: ./build.sh --no-run"
          ./build.sh --no-run

          # éªŒè¯é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸ
          if docker images | grep -q "ruoqi-sys-admin"; then
            echo "âœ… Docker é•œåƒæ„å»ºæˆåŠŸ"
            echo "é•œåƒè¯¦æƒ…:"
            docker images | grep "ruoqi-sys-admin"
          else
            echo "âŒ Docker é•œåƒæ„å»ºå¤±è´¥"
            exit 1
          fi

      # 6. æ¨é€é•œåƒåˆ° Docker Hub
      - name: Push to Docker Hub
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        env:
          # æ˜ç¡®ä¼ é€’ç¯å¢ƒå˜é‡åˆ°å­è¿›ç¨‹
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
        run: |
          echo "=== æ¨é€é•œåƒåˆ° Docker Hub ==="
          echo "å½“å‰ç›®å½•: $(pwd)"

          # è¿›å…¥è„šæœ¬ç›®å½•
          cd scripts/ruoqi-sys-admin-build

          # è°ƒè¯•ï¼šæ˜¾ç¤ºç¯å¢ƒå˜é‡
          echo "ç¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "DOCKER_HUB_USERNAME: ${DOCKER_HUB_USERNAME}"
          echo "DOCKER_HUB_ACCESS_TOKEN: ${DOCKER_HUB_ACCESS_TOKEN:0:10}..."

          # ç¡®å®šè¦æ¨é€çš„æ ‡ç­¾
          if [[ "${{ steps.version.outputs.manual_tag }}" == "true" ]]; then
            # ä½¿ç”¨æ‰‹åŠ¨æ ‡ç­¾
            TAGS=("${{ steps.version.outputs.tag }}")
            echo "ä½¿ç”¨æ‰‹åŠ¨æ ‡ç­¾: ${TAGS[0]}"
          else
            # ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æ ‡ç­¾
            TAGS=(
              "${{ steps.version.outputs.tag_latest }}"
              "${{ steps.version.outputs.tag_version }}"
              "${{ steps.version.outputs.tag_date_version }}"
              "${{ steps.version.outputs.tag_full }}"
            )
            echo "ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„æ ‡ç­¾:"
            printf '  - %s\n' "${TAGS[@]}"
          fi

          # æ¨é€æ‰€æœ‰æ ‡ç­¾
          for TAG in "${TAGS[@]}"; do
            echo ""
            echo "ğŸ”¹ æ¨é€æ ‡ç­¾: ${TAG}"
            echo "----------------------------------------"

            # ç¡®ä¿ç¯å¢ƒå˜é‡ä¼ é€’ç»™è„šæœ¬
            export DOCKER_HUB_USERNAME="${DOCKER_HUB_USERNAME}"
            export DOCKER_HUB_ACCESS_TOKEN="${DOCKER_HUB_ACCESS_TOKEN}"

            ./push.sh "${TAG}"

            # æ·»åŠ å»¶æ—¶ï¼Œé¿å… Docker Hub é™æµ
            if [ "$TAG" != "${TAGS[-1]}" ]; then
              echo "ç­‰å¾… 2 ç§’åæ¨é€ä¸‹ä¸€ä¸ªæ ‡ç­¾..."
              sleep 2
            fi
          done

          echo "ğŸ‰ æ‰€æœ‰é•œåƒæ¨é€å®Œæˆï¼"

      # 7. åˆ›å»ºæ„å»ºæ‘˜è¦
      - name: Create build summary
        if: always()
        run: |
          echo "## ğŸ—ï¸ RuoQi Sys Admin æ„å»ºæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ„å»ºçŠ¶æ€
          if [ "${{ job.status }}" = "success" ]; then
            echo "### âœ… æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # é•œåƒä¿¡æ¯éƒ¨åˆ†
          echo "### ğŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "**å·²æ¨é€åˆ° Docker Hub:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [[ "${{ steps.version.outputs.manual_tag }}" == "true" ]]; then
              echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:latest\`" >> $GITHUB_STEP_SUMMARY
              echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_version }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_date_version }}\`" >> $GITHUB_STEP_SUMMARY
              echo "- \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ steps.version.outputs.tag_full }}\`" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Docker Hub é“¾æ¥:**" >> $GITHUB_STEP_SUMMARY
            echo "- [ä»“åº“ä¸»é¡µ](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin)" >> $GITHUB_STEP_SUMMARY
            echo "- [æ‰€æœ‰æ ‡ç­¾](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin/tags)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**æœ¬åœ°é•œåƒ:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`ruoqi-sys-admin:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> æ³¨ï¼šæœ¬æ¬¡ä¸º PR æˆ–æµ‹è¯•æ„å»ºï¼Œé•œåƒæœªæ¨é€åˆ° Docker Hub" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # æ„å»ºè¯¦æƒ…
          echo "### ğŸ“Š æ„å»ºè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| é¡¹ç›® | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| **ç‰ˆæœ¬** | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **æäº¤** | [${{ steps.version.outputs.sha_short }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **æ„å»ºæ—¥æœŸ** | ${{ steps.version.outputs.date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **è§¦å‘æ–¹å¼** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **è§¦å‘è€…** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **åˆ†æ”¯** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **å·¥ä½œæµ** | [${{ github.workflow }} #${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # æ ‡ç­¾è¯¦æƒ…
          echo "### ğŸ·ï¸ æ ‡ç­¾è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.version.outputs.manual_tag }}" == "true" ]]; then
            echo "- **æ‰‹åŠ¨æ ‡ç­¾:** \`${{ steps.version.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **latest:** \`${{ steps.version.outputs.tag_latest }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **è¯­ä¹‰åŒ–ç‰ˆæœ¬:** \`${{ steps.version.outputs.tag_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **å¸¦æ—¥æœŸç‰ˆæœ¬:** \`${{ steps.version.outputs.tag_date_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **å®Œæ•´ç‰ˆæœ¬:** \`${{ steps.version.outputs.tag_full }}\`" >> $GITHUB_STEP_SUMMARY
          fi

      # 8. ä¸Šä¼ æ„å»ºæ—¥å¿—
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            scripts/ruoqi-sys-admin-build/build.log
            scripts/ruoqi-sys-admin-build/*.log
          retention-days: 30

      # 9. æ¸…ç† Docker èµ„æº
      - name: Cleanup Docker resources
        if: always()
        run: |
          echo "=== æ¸…ç† Docker èµ„æº ==="

          # åˆ é™¤æ„å»ºçš„é•œåƒ
          docker rmi ruoqi-sys-admin:latest 2>/dev/null || true

          # æ¸…ç†æ— ç”¨çš„ Docker èµ„æº
          docker system prune -f 2>/dev/null || true

          echo "âœ… èµ„æºæ¸…ç†å®Œæˆ"

  # 10. é€šçŸ¥ä»»åŠ¡
  notification:
    name: ğŸ“¢ Build Notification
    runs-on: ubuntu-latest
    needs: [build_and_push]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "=== RuoQi Sys Admin æ„å»ºé€šçŸ¥ ==="
          echo ""

          # åŸºæœ¬æ„å»ºä¿¡æ¯
          echo "**é¡¹ç›®:** RuoQi Sys Admin"
          echo "**ä»“åº“:** ${{ github.repository }}"
          echo "**åˆ†æ”¯:** ${{ github.ref_name }}"
          echo "**è§¦å‘è€…:** ${{ github.actor }}"
          echo "**å·¥ä½œæµ:** ${{ github.workflow }} #${{ github.run_number }}"
          echo "**çŠ¶æ€:** ${{ needs.build_and_push.result }}"
          echo ""

          # æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
          if [ "${{ needs.build_and_push.result }}" = "success" ]; then
            echo "ğŸ‰ **æ„å»ºæˆåŠŸï¼**"
            echo ""

            # é•œåƒä¿¡æ¯
            if [[ "${{ github.event_name }}" != "pull_request" && "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "ğŸ“¦ **Docker é•œåƒå·²å‘å¸ƒ:**"
              echo ""

              if [[ "${{ needs.build_and_push.outputs.manual_tag }}" == "true" ]]; then
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag }}\`"
              else
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:latest\`"
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag_version }}\`"
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag_date_version }}\`"
                echo "  \`${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin:${{ needs.build_and_push.outputs.tag_full }}\`"
              fi

              echo ""
              echo "ğŸ”— **ç›¸å…³é“¾æ¥:**"
              echo "  - [Docker Hub ä»“åº“](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin)"
              echo "  - [æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾](https://hub.docker.com/r/${{ env.DOCKER_HUB_USERNAME }}/ruoqi-sys-admin/tags)"
              echo "  - [æ„å»ºè¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            else
              echo "ğŸ§ª **æµ‹è¯•æ„å»ºå®Œæˆ**"
              echo "é•œåƒä»…åœ¨æœ¬åœ°æ„å»ºï¼Œæœªæ¨é€åˆ° Docker Hub"
            fi
          else
            echo "âŒ **æ„å»ºå¤±è´¥ï¼**"
            echo ""
            echo "è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› :"
            echo "  1. æ„å»ºè„šæœ¬æ‰§è¡Œå¤±è´¥"
            echo "  2. Docker é•œåƒæ„å»ºé”™è¯¯"
            echo "  3. ç½‘ç»œè¿æ¥é—®é¢˜"
            echo "  4. æƒé™é…ç½®é”™è¯¯"
            echo ""
            echo "ğŸ“‹ **æ’æŸ¥æ­¥éª¤:**"
            echo "  1. æŸ¥çœ‹ GitHub Actions æ—¥å¿—"
            echo "  2. æ£€æŸ¥ Secrets é…ç½®"
            echo "  3. éªŒè¯æœ¬åœ°æ„å»ºæ˜¯å¦æ­£å¸¸"
            echo ""
            echo "ğŸ”— **æ„å»ºæ—¥å¿—:**"
            echo "  https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo ""
          echo "---"
          echo "ğŸ“Š **æ„å»ºä¿¡æ¯æ±‡æ€»:**"
          echo "- ç‰ˆæœ¬: ${{ needs.build_and_push.outputs.version }}"
          echo "- æäº¤: ${{ needs.build_and_push.outputs.sha_short }}"
          echo "- æ—¥æœŸ: ${{ needs.build_and_push.outputs.date }}"
          echo "- è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
